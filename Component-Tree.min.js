!function(){ne=ne||{},ne.component=ne.component||{},ne.component.Tree=ne.util.defineClass({init:function(a){this.model=new ne.component.Tree.TreeModel(a.config),this.model.setData(a.data),this.inputElement=document.createElement("input"),this.inputElement.className=a.config.inputElementClass||"",this.inputElement.setAttribute("type","text"),this.view=new ne.component.Tree.TreeView(a.config,this.model.getFirstChildren()),this.event=new ne.component.Tree.TreeEvent,this.isInputEnabled=!1,this.editableObject=null,this.model.listen(this.view),this._setEvent()},_setEvent:function(){this.event.add(this.view.root,"click",ne.util.bind(this._onClickEvent,this)),this.event.add(this.view.root,"doubleclick",ne.util.bind(this._onDoubleClick,this))},_onClickEvent:function(a){a.isButton?this.model.changeState(a.paths):a.paths&&(this.model.setBuffer(a.paths),this.fire("click",a))},_onDoubleClick:function(a){var b=a.target,c=this._getValueElement(a.path),d=this.inputElement;this.editableObject={element:b,path:a.path,valueElement:c},b.insertBefore(d,c),c.style.display="none",d.style.display="",d.value=this.model.findNode(a.path).title,d.focus(),this.isInputEnabled||this._openInputEvent()},_getValueElement:function(a){var b=this.model.findNode(a),c=document.getElementById(b.id);return c},_updateName:function(){var a=this.inputElement.value;a&&this.rename(this.editableObject.path,a),this._stopEditable()},_onKeyDownInputElement:function(a){13===a.keyCode&&this._updateName()},_onBlurInputElement:function(){this._updateName()},_onClickInputElement:function(a){ne.component.Tree.treeUtils.stopEvent(a)},_openInputEvent:function(){var a=ne.component.Tree.treeUtils;this.isInputEnabled=!0,a.addEventListener(this.inputElement,"keyup",ne.util.bind(this._onKeyDownInputElement,this)),a.addEventListener(this.inputElement,"blur",ne.util.bind(this._onBlurInputElement,this)),a.addEventListener(this.inputElement,"click",ne.util.bind(this._onClickInputElement,this))},_stopEditable:function(){this.inputElement.value="",this.inputElement.style.display="none",this.editableObject.valueElement.style.display=""},insert:function(a,b){var c=this.invoke("insert",{path:a,value:b});c&&(b?(a=a.toString(),this.model.insertNode(a,b)):(b=a,this.model.insertNode(null,b)))},remove:function(a){if(a){var b=this.invoke("remove",{path:a});b&&this.model.removeNode(a)}},rename:function(a,b){var c=this.invoke("rename",{path:a,value:b});c&&this.model.renameNode(a,b)},sort:function(a,b){this.model.sort(a,b)},getModelData:function(){return this.model.getData()},setDepthLabels:function(a){if(!a||!ne.util.isObject(a))throw new TypeError;this.view.setDepthLabels(a),this.view.action("refresh",this.model.nodes)}}),ne.util.CustomEvents.mixin(ne.component.Tree),ne.component.Tree.TreeNode=ne.util.defineClass({init:function(a){this.id=a.id,this.title=a.title,this.type=a.type||"default",this.state=a.state||"close",this.childNodes=null,this.parent=null,this.siblings=null},set:function(a,b){this[a]=b},get:function(a){return this[a]}}),ne.component.Tree.TreeEvent=ne.util.defineClass({init:function(){this.doubleClickTimer=null},add:function(a,b,c){"doubleclick"===b?this._addDoubleClickEvent(a,b,c):this._addEventListener(a,b,c)},_addEventListener:function(a,b,c){ne.component.Tree.treeUtils.addEventListener(a,b,ne.util.bind(this._onClick,this,c,b))},_onClick:function(a,b,c){c=c||window.event;var d=c.target||c.srcElement,e=d.tagName.toLowerCase(),f=null;if(this._checkRightButton(c.which||c.button))return void ne.component.Tree.treeUtils.stopEvent(c);if("button"===e){var g=d.parentNode,h=g;f=h.getAttribute("path")}else f=d.getAttribute("path"),f||(f=d.parentNode.getAttribute("path"));ne.util.extend(c,{eventType:b,isButton:"button"===e,target:d,paths:f}),a(c)},_addDoubleClickEvent:function(a,b,c){ne.component.Tree.treeUtils.addEventListener(a,"click",ne.util.bind(this._onDoubleClick,this,c,b))},_onDoubleClick:function(a,b,c){c=c||window.event;var d=c.target||c.srcElement,e="BUTTON"===c.target.tagName.toUpperCase(),f=d.getAttribute("path")||d.parentNode.getAttribute("path"),d=d.parentNode.getAttribute("path")?d.parentNode:d,g=d.innerText;return e?void(this.doubleClickTimer=null):this._checkRightButton(c.which||c.button)?(this.doubleClickTimer=null,void ne.component.Tree.treeUtils.stopEvent(c)):f||isNaN(f)?(this.targetPath&&this.targetPath!==f&&(this.doubleClickTimer=null),this.doubleClickTimer?(a({eventType:b,target:d,path:f,text:g}),this.doubleClickTimer=null):this.doubleClickTimer=setTimeout(ne.util.bind(function(){this.doubleClickTimer=null},this),500),void(this.targetPath=f)):void(this.doubleClickTimer=null)},_checkRightButton:function(a){var b=3==a||2==a;return b}}),ne.component.Tree.TreeModel=ne.util.defineClass({init:function(a){this.nodes=new ne.component.Tree.TreeNode({id:a.viewId,title:"",state:"open"}),this.count=0,this.views=[],this.nodeDefaultState=a.defaultState||"close",this.buffer=null,this.date=(new Date).getTime()},setData:function(a){this.data=a,this._makeTree(this.data,this.nodes)},listen:function(a){this.views.push(a)},_notify:function(a,b){ne.util.forEach(this.views,function(c){c.action(a,b)})},getFirstChildren:function(){return this.nodes.childNodes},insertNode:function(a,b){b||(b={title:"no Title"}),ne.util.isArray(b)||(b=[b]);var c=null;a&&(c=this.findNode(a)),c=c||this.nodes,this._makeTree(b,c),this._notify("refresh",c)},removeNode:function(a){if(!a)throw new Error("must insert target ID");var b=this.findNode(a),c=b.parent;c.childNodes=ne.util.filter(c.childNodes,function(a){return a!==b}),b.parent=null,this._notify("remove",c)},findNode:function(a){var b=null,c=a.split(",");return ne.util.forEach(c,ne.util.bind(function(a){b=b?b.childNodes&&b.childNodes[a]:this.nodes.childNodes&&this.nodes.childNodes[a]},this)),b},_makeTree:function(a,b){b.childNodes||(b.childNodes=[]),ne.util.forEach(a,ne.util.bind(function(a){var c=new ne.component.Tree.TreeNode({id:this._getIdentification(),title:a.title,state:this.nodeDefaultState});b?(c.parent=b,b.childNodes.push(c)):c.parent=this.nodes,a.children&&this._makeTree(a.children,c)},this))},_getIdentification:function(){var a="tree_"+this.date;return a+"_"+this.count++},renameNode:function(a,b){var c=this.findNode(a);c.set("title",b),this._notify("rename",c)},changeState:function(a){var b=this.findNode(a);"open"===b.get("state")?b.set("state","close"):b.set("state","open"),this._notify("toggle",b)},setBuffer:function(a){this.clearBuffer();var b=this.findNode(a);this.buffer=b,this._notify("select",b)},clearBuffer:function(){if(this.buffer){var a=this.buffer;this.buffer=null,this._notify("unselect",a)}},getData:function(){return this.nodes},sort:function(a,b){var c=this.findNode(a)||this.nodes;c.childNodes.sort(b),this._notify("refresh",c)},sortChild:function(a){a.sort(function(a,b){return a.title<b.title?-1:a.title>b.title?1:0})}}),ne.component.Tree.TreeView=ne.util.defineClass({init:function(a,b){this.template=a.template||{hasChild:'<li class="hasChild {{State}}" path="{{Path}}">                            <button type="button">{{StateLabel}}</button>                            <span id="{{NodeID}}" class="depth{{Depth}}">{{Title}}</span><em>{{DepthLabel}}</em>                            <ul class="subTree">                                {{ChildNodes}}                            </ul>                        </li>',leapNode:'<li class="leapNode" path="{{Path}}">                        <span id="{{NodeID}}" class="depth{{Depth}}">{{Title}}</span><em>{{DepthLabel}}</em>                    </li>'},this.root=null,this.path=[],this.openSet=a.openSet||["open","-"],this.closeSet=a.closeSet||["close","+"],this.onSelectClassName=a.onSelectClassName||"select",this.depthLabels=a.depthLabels||[],a.viewId?this.root=document.getElementById(a.viewId):(this.root=document.createElement("ul"),document.body.appendChild(this.root)),this._makeTree(b)},_makeTree:function(a){this._draw(this._makeHTML(a))},_makeHTML:function(a,b){var c,d=[],b=b||null,e="",f=a.length;return ne.util.forEach(a,function(a,c){this.path.push(c),e=null!==b?[b,this.path.join()].join():this.path.join();var g=e.split(",").length,h=this.depthLabels[g-1]||"",i=this[a.state+"Set"][0],j=this[a.state+"Set"][1],k=null,l={State:i,StateLabel:j,NodeID:a.id,Path:e,Depth:g,Title:a.title,DepthLabel:h};ne.util.isNotEmpty(a.childNodes)?(k=this.template.hasChild,l.ChildNodes=this._makeHTML(a.childNodes,b)):k=this.template.leapNode,k=k.replace(/\{\{([^\}]+)\}\}/g,function(a,b){return l[b]||""}),c===f-1&&1!==g&&(k=k.replace('class="','class="last '));var m="close"===a.get("state");m&&(k=k.replace("<ul ",'<ul style="display:none"')),d.push(k),this.path.pop()},this),c=d.join("")},_changeTargetClass:function(a){var b=document.getElementById(a.id);if(b){var c=b.parentNode,d=c.className;d=a.childNodes&&!a.childNodes.length?"leapNode "+this[a.state+"Set"][0]:"hasChild "+this[a.state+"Set"][0],c.className=d}},action:function(a,b){this._actionMap=this._actionMap||{remove:this._remove,refresh:this._refresh,rename:this._rename,toggle:this._toggle,select:this._select,unselect:this._unSelect},this._actionMap[a].call(this,b)},_draw:function(a,b){var c=b||this.root;c.innerHTML=a},setDepthLabels:function(a){this.depthLabels=a},_remove:function(a){var b=document.getElementById(a.id);b&&(b=b.parentNode.getElementsByTagName("ul")[0]),this._changeTargetClass(a);var c=a.childNodes;this._draw(this._makeHTML(c),b)},_refresh:function(a){this._changeTargetClass(a);var b=a.childNodes,c=a.get("id");c&&c!==this.root.getAttribute("id")?this._refreshPartOfTree(a):this._draw(this._makeHTML(b))},_refreshPartOfTree:function(a){var b,c,d=a.get("id"),e=document.getElementById(d),f=a.parent,g=f.get("id"),h=e.getElementsByTagName("ul")&&e.getElementsByTagName("ul")[0],i=!!h;i?b=a.childNodes:(e=document.getElementById(g),h=e.parentNode.getElementsByTagName("ul")[0],b=f.childNodes),c=e.parentNode.getAttribute("path"),c?this._draw(this._makeHTML(b,c),h):this._draw(this._makeHTML(b))},_rename:function(a){var b=a.get("id"),c=document.getElementById(b);c.innerHTML=a.title},_toggle:function(a){var b=document.getElementById(a.get("id")),c=b.parentNode,d=c.getElementsByTagName("ul")[0],e=c.getElementsByTagName("button")[0],f=this[a.state+"Set"][0],g=this[a.state+"Set"][1],h="open"===a.get("state");c.className=c.className.replace(this.openSet[0],"").replace(this.closeSet[0],"")+f,d.style.display=h?"":"none",e.innerHTML=g},_select:function(a){var b=document.getElementById(a.id);ne.util.isExisty(b)&&(b.className=b.className.replace(" "+this.onSelectClassName,"")+" "+this.onSelectClassName)},_unSelect:function(a){var b=document.getElementById(a.id);ne.util.isExisty(b,"className")&&-1!==b.className.indexOf(this.onSelectClassName)&&(b.className=b.className.replace(" "+this.onSelectClassName,""))}}),ne.component.Tree.treeUtils={addEventListener:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},removeEventListener:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)},stopEvent:function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}}}();